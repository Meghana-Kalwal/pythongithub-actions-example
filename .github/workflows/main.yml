name: Vulnerable CI/CD + Semgrep SAST

on:
  push:
  pull_request:

jobs:
  vulnerable_pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ❌ Hardcoded secret
      - name: Print secret (INSECURE)
        run: |
          echo "HARDCODED_SECRET=abcd1234"

      # ❌ Dangerous eval usage
      - name: Dangerous shell command
        run: |
          USER_INPUT="${{ github.actor }}"
          eval "echo Processing user: $USER_INPUT"

      # Install Python
      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ⭐ FIXED: Installing Flask directly (no requirements.txt needed)
      - name: Install Flask
        run: |
          pip install Flask

      # ❌ Environment variables exposure
      - name: Print environment
        run: env | grep SECRET || true

  semgrep_scan:
    runs-on: ubuntu-latest
    needs: vulnerable_pipeline

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep (Full SAST Scan)
        run: |
          semgrep --config=p/security-audit --json > semgrep_results.json

      - name: Upload Semgrep Results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results
          path: semgrep_results.json
